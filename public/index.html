<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Old Skool Blackjack â€” Online</title>
  <style>
    :root {
      --chalk-green: #3a5f42;
      --chalk-white: #eeeeee;
      --paper-white: #fdfbf7;
      --line-blue: #a2d2ff;
      --sticker-yellow: #ffeb3b;
      --sticker-pink: #ff80ab;
      --sticker-blue: #80d8ff;
      --card-w: 70px;
      --card-h: 100px;
    }

    body {
      font-family: "Comic Sans MS", "Chalkboard SE", "Marker Felt", sans-serif;
      background-color: var(--chalk-green);
      color: var(--chalk-white);
      margin: 0;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      touch-action: manipulation;
      background-image: radial-gradient(#4a6f52 2px, transparent 2px);
      background-size: 30px 30px;
    }

    @media (max-width: 600px) {
      :root { --card-w: 60px; --card-h: 84px; }
      .hud-btn { padding: 10px 10px !important; font-size: 0.8rem !important; }
      #game-info-bar { font-size: 0.8rem !important; padding: 4px !important; }
    }

    /* --- ANIMATIONS --- */
    @keyframes shake {
      0% { transform: translateX(0) translateY(-25px); }
      25% { transform: translateX(-5px) rotate(-5deg) translateY(-25px); }
      50% { transform: translateX(5px) rotate(5deg) translateY(-25px); }
      75% { transform: translateX(-5px) rotate(-5deg) translateY(-25px); }
      100% { transform: translateX(0) translateY(-25px); }
    }
    .shake { animation: shake 0.4s ease-in-out; border-color: #ff5252 !important; }

    @keyframes popIn {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      80% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    @keyframes rainbow-glow {
      0% { box-shadow: 0 0 10px #ff0000; border-color: #ff0000; }
      50% { box-shadow: 0 0 10px #25d1cb; border-color: #25d1cb; }
      100% { box-shadow: 0 0 10px #ff00c8; border-color: #ff00c8; }
    }
    .winning-btn {
      animation: rainbow-glow 0.5s infinite;
      transform: scale(1.05) !important;
      background: white !important;
      color: black !important;
    }

    /* --- SCREENS --- */
    .screen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: none; flex-direction: column; justify-content: center; align-items: center;
      background: var(--chalk-green); z-index: 10;
    }
    .screen.active { display: flex; }

    /* PAPER BACKGROUNDS */
    #login-screen, #menu-screen, #lobby-screen {
      background-color: var(--paper-white);
      background-image: linear-gradient(var(--line-blue) 1px, transparent 1px);
      background-size: 100% 25px;
      color: #333;
    }

    /* LOGO & BRANDING */
    .logo-badge {
      display: inline-flex; align-items: center; gap: 10px; background: white;
      padding: 10px 16px; border: 3px solid #333; border-radius: 12px;
      box-shadow: 5px 5px 0 rgba(0,0,0,0.2); transform: rotate(-2deg); margin-bottom: 25px;
    }
    .logo-mark {
      width: 42px; height: 42px; display: inline-flex; align-items: center; justify-content: center;
      border: 2px solid #333; border-radius: 10px; background: var(--sticker-yellow);
      font-size: 26px; color: black;
    }
    .logo-text { font-size: 2.2rem; font-weight: 900; color: #111; line-height: 0.9; }

    input[type="text"] {
      padding: 10px; font-family: inherit; font-size: 1.3rem;
      background: transparent; color: #333; border: none;
      border-bottom: 3px solid #333; width: 280px; text-align: center;
      margin-bottom: 18px; outline: none;
    }

    /* BUTTONS */
    .menu-btn {
      width: 85%; max-width: 340px; padding: 15px; border: 3px solid #333;
      border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
      font-family: inherit; font-size: 1.4rem; font-weight: bold; text-transform: uppercase;
      cursor: pointer; display: flex; flex-direction: column; align-items: center;
      gap: 5px; box-shadow: 3px 3px 0 #333; margin-bottom: 15px; background: white; color: #333;
    }
    .menu-btn:active { transform: scale(0.95); box-shadow: 1px 1px 0 #333; }
    .btn-league { background: var(--sticker-yellow); transform: rotate(1deg); }
    .btn-party { background: var(--sticker-blue); transform: rotate(-1deg); }
    .btn-start { background: var(--sticker-pink); }
    .menu-btn small { font-size: 0.8rem; font-weight: normal; opacity: 0.8; text-transform: none; }

    /* LOBBY BOX */
    .lobby-box {
      width: 90%; max-width: 520px; background: white; border: 3px solid #333;
      border-radius: 14px; padding: 15px; box-shadow: 5px 5px 0 rgba(0,0,0,0.1);
      margin-bottom: 15px; text-align: center;
    }
    .lobby-code {
      font-family: monospace; font-size: 2rem; background: #fff9c4;
      border: 2px dashed #333; padding: 10px; margin: 10px 0; display: inline-block;
    }

    /* GAME UI */
    #status-feed {
      position: absolute; top: 0; left: 0; width: 100%; height: 35px;
      background: rgba(0,0,0,0.3); color: white; font-family: "Chalkduster", fantasy, sans-serif;
      display: flex; align-items: center; justify-content: center; z-index: 20;
    }
    #game-info-bar {
      position: absolute; top: 40px; left: 10px; right: 10px; height: 35px;
      display: flex; justify-content: space-between; align-items: center; z-index: 5;
    }
    .help-btn {
      background: var(--sticker-yellow); color: black; border: 2px solid black;
      border-radius: 50%; width: 35px; height: 35px; font-weight: 900; cursor: pointer;
    }

    #cpu-area {
      position: absolute; top: 80px; width: 100%; display: flex;
      justify-content: space-around; height: 120px; padding: 0 10px;
    }
    .opponent-wrapper {
      display: flex; flex-direction: column; align-items: center;
      transform: scale(0.85); transition: opacity 0.3s;
    }
    .opponent-wrapper.active-turn { opacity: 1; transform: scale(1.1); }
    .opponent-name {
      background: white; color: black; border: 2px solid black; border-radius: 15px 15px 15px 0;
      padding: 4px 10px; font-weight: bold; margin-bottom: 5px; box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
    }

    #center-area {
      position: absolute; top: 52%; left: 50%; transform: translate(-50%, -50%);
      display: flex; gap: 20px; z-index: 2;
    }

    #game-hud {
      position: absolute; top: 62%; right: 10px; transform: translateY(-50%);
      display: flex; flex-direction: column; gap: 10px; z-index: 100;
    }
    .hud-btn {
      padding: 15px 10px; color: black; border: 3px solid black; border-radius: 10px;
      font-weight: 900; cursor: pointer; box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
      font-size: 0.9rem; text-transform: uppercase; font-family: inherit; background: white;
    }
    #btn-play { background: var(--sticker-pink); transform: rotate(-2deg); }
    #btn-pickup { background: var(--sticker-blue); transform: rotate(2deg); }
    #btn-last { background: var(--sticker-yellow); transform: rotate(-1deg); }
    .hud-btn:disabled { background: #ccc; color: #777; transform: none; box-shadow: none; }
    #btn-last.called { background: #4caf50; color: white; transform: scale(0.95); box-shadow: none; }

    #player-area {
      position: absolute; bottom: 0; width: 100%; height: calc(var(--card-h) + 60px);
      z-index: 50; overflow-x: auto; white-space: nowrap; padding: 0 20px;
      background-color: #d2a679;
      background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px);
      border-top: 5px solid #8d6e63; box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
    }
    .hand { display: inline-flex; justify-content: center; min-width: 100%; padding-top: 25px; align-items: flex-end; }

    /* CARDS */
    .card {
      width: var(--card-w); height: var(--card-h); background: white; border-radius: 8px;
      border: 2px solid #333; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); position: relative;
      display: inline-flex; flex-direction: column; color: black; flex-shrink: 0;
      margin-left: -35px; cursor: pointer;
      /* Fan support */
      transform: rotate(var(--fan-rot, 0deg)) translateY(var(--fan-y, 0px));
      transform-origin: bottom center; transition: transform 0.2s, margin 0.1s;
    }
    .card:first-child { margin-left: 0; }
    .card.red { color: #d32f2f; }
    .card.back {
      background-color: #000;
      background-image: radial-gradient(white 15%, transparent 16%), radial-gradient(white 15%, transparent 16%);
      background-size: 10px 10px; background-position: 0 0, 5px 5px; border: 3px solid white;
    }
    .card.back * { display: none; }
    .card.selected {
      border: 4px solid var(--sticker-pink);
      transform: rotate(var(--fan-rot)) translateY(calc(var(--fan-y) - 40px)) scale(1.1);
      z-index: 100 !important;
    }
    .selection-badge {
      position: absolute; top: -10px; right: -10px; background: var(--sticker-pink);
      color: black; border-radius: 50%; width: 24px; height: 24px; text-align: center;
      line-height: 24px; font-weight: bold; z-index: 101; border: 2px solid black;
    }
    .card-corner { position: absolute; top: 2px; left: 4px; display: flex; flex-direction: column; align-items: center; line-height: 0.9; }
    .card-corner .rank { font-size: 22px; font-weight: 900; }
    .card-corner .suit { font-size: 20px; margin-top: -2px; }
    .center-suit { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); font-size: 36px; opacity: 0.2; }
    .card-bottom { position: absolute; bottom: 2px; right: 4px; transform: rotate(180deg); display: flex; flex-direction: column; align-items: center; line-height: 0.9; }
    .card-bottom .rank { font-size: 22px; font-weight: 900; }
    .card-bottom .suit { font-size: 20px; margin-top: -2px; }

    /* MODALS */
    #match-result-modal, #suit-modal, #help-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); display: none;
      justify-content: center; align-items: center; z-index: 200; flex-direction: column; color: white;
    }
    .suit-btn {
      font-size: 50px; width: 80px; height: 80px; margin: 10px; cursor: pointer;
      background: white; border-radius: 20px; border: 3px solid black; box-shadow: 5px 5px 0 rgba(0,0,0,0.5);
    }
    
    /* TOAST */
    #toast-notification {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
      background: var(--chalk-green); color: var(--chalk-white); padding: 20px 40px;
      border: 4px dashed var(--chalk-white); border-radius: 15px;
      font-family: "Chalkduster", fantasy, sans-serif; font-size: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0; pointer-events: none;
      transition: opacity 0.2s, transform 0.2s; z-index: 300; text-align: center;
    }
    #toast-notification.show { opacity: 1; transform: translate(-50%, -50%) scale(1); animation: popIn 0.3s forwards; }
  </style>
</head>
<body data-cardback="classic">
  <div id="toast-notification"></div>

  <div id="login-screen" class="screen active">
    <div class="logo-badge">
      <div class="logo-mark">â™ </div>
      <div class="logo-text">Old Skool<br>Blackjack</div>
    </div>
    <input type="text" id="username-input" placeholder="Your Name" maxlength="10" />
    <button class="menu-btn btn-start" onclick="signUp()">Enter</button>
  </div>

  <div id="menu-screen" class="screen">
    <div class="logo-text" style="font-size: 1.5rem; margin-bottom: 20px;">
      Player: <span id="menu-username"></span>
    </div>
    
    <button class="menu-btn btn-league" onclick="goToLobby()">
      ðŸ“¡ Online Lobby<small>Host or Join Room</small>
    </button>
  </div>

  <div id="lobby-screen" class="screen">
    <div class="logo-text" style="font-size:1.8rem; margin-bottom:15px; color:#333;">ONLINE TABLE</div>
    
    <div class="lobby-box">
      <div style="font-weight:900; margin-bottom:5px;">Room Status</div>
      <div id="lobby-status" style="color:#555;">Connecting to server...</div>
    </div>

    <div class="lobby-box">
      <div style="font-weight:900; margin-bottom:10px;">Join a Friend</div>
      <input id="join-code-input" type="text" placeholder="Enter Room Code" style="border:2px solid #ccc; background:white;">
      <div style="display:flex; justify-content:center; gap:10px;">
        <button class="menu-btn btn-party" style="width:140px; margin:0; transform:none;" onclick="p2pJoin()">JOIN</button>
        <button class="menu-btn btn-league" style="width:140px; margin:0; transform:none;" onclick="p2pHost()">CREATE</button>
      </div>
    </div>

    <div id="host-panel" class="lobby-box" style="display:none; border-color:var(--sticker-pink);">
      <div style="font-weight:900;">Share this Code:</div>
      <div class="lobby-code" id="my-room-code">...</div>
      <div style="margin-bottom:10px;">Waiting for player...</div>
      <button class="menu-btn btn-start" id="btn-deal" onclick="p2pDeal()" disabled style="width:100%; transform:none;">DEAL CARDS!</button>
    </div>
    
    <button onclick="showScreen('menu-screen')" style="background:none; border:none; color:#333; font-weight:bold; margin-top:10px; cursor:pointer;">â†© Back to Menu</button>
  </div>

  <div id="game-screen" class="screen">
    <div id="status-feed">Waiting for game...</div>
    <div id="game-info-bar">
      <div id="turn-status"></div>
      <div id="attack-status" style="color:var(--sticker-yellow); font-weight:bold; text-shadow:1px 1px 0 #000;"></div>
      <button class="help-btn" onclick="openHelp()">?</button>
    </div>

    <div id="cpu-area"></div>

    <div id="center-area">
      <div id="draw-pile" class="card back" onclick="humanPickup()"></div>
      <div id="discard-pile"></div>
    </div>

    <div id="game-hud">
      <button class="hud-btn" id="btn-play" onclick="humanPlay()" disabled>PLAY</button>
      <button class="hud-btn" id="btn-pickup" onclick="humanPickup()">DRAW</button>
      <button class="hud-btn" id="btn-last" onclick="humanDeclareLast()">LAST!</button>
    </div>

    <div id="player-area">
      <div id="player-hand" class="hand"></div>
    </div>
  </div>

  <div id="match-result-modal">
    <h1 id="result-title" style="font-size:4rem; margin:0; color:var(--sticker-yellow); text-shadow:4px 4px 0 #000;"></h1>
    <p id="result-desc" style="font-size:1.5rem; color:#fff"></p>
    <button class="menu-btn btn-start" onclick="location.reload()">Back to Menu</button>
  </div>

  <div id="suit-modal">
    <h2 style="color:white">Pick a Suit!</h2>
    <div style="display:flex; flex-wrap:wrap; justify-content:center">
      <button class="suit-btn" onclick="resolveAce('H')" style="color:#b71c1c">â™¥</button>
      <button class="suit-btn" onclick="resolveAce('D')" style="color:#b71c1c">â™¦</button>
      <button class="suit-btn" onclick="resolveAce('C')" style="color:black">â™£</button>
      <button class="suit-btn" onclick="resolveAce('S')" style="color:black">â™ </button>
    </div>
  </div>

  <div id="help-modal" onclick="closeHelp()">
    <div style="background:white; color:#333; border:4px solid black; padding:20px; border-radius:20px; width:300px;">
      <h2>CHEAT SHEET</h2>
      <p><b>2</b>: Draw 2 (Stacks)</p>
      <p><b>8</b>: Skip Turn</p>
      <p><b>J</b>: Black=Draw 5 / Red=Block</p>
      <p><b>Q</b>: Reverse</p>
      <p><b>K</b>: Go Again</p>
      <p><b>A</b>: Wild</p>
      <button class="menu-btn btn-league" style="width:100%; margin-top:10px" onclick="closeHelp()">OK</button>
    </div>
  </div>

  <script>
    // --- AUDIO ENGINE (Original) ---
    const AudioEngine = {
      ctx: null,
      init: function () { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
      playTone: function (freq, type, duration, vol) {
        this.init(); if (this.ctx.state === "suspended") this.ctx.resume();
        const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol || 0.1, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain); gain.connect(this.ctx.destination);
        osc.start(); osc.stop(this.ctx.currentTime + duration);
      },
      playCardSnap: function () { this.playTone(600, "triangle", 0.1, 0.15); },
      playError: function () { this.playTone(150, "sawtooth", 0.3, 0.2); },
      playCall: function () { this.playTone(800, "square", 0.1, 0.1); },
      playWin: function () { [400, 500, 600, 800].forEach((f, i) => setTimeout(() => this.playTone(f, "square", 0.3, 0.1), i * 100)); },
    };

    // --- STATE ---
    let ws = null;
    let myId = null;
    let myName = "";
    let gameState = null;
    let selectionOrder = [];

    // --- UI HELPERS ---
    function showScreen(id) {
      document.querySelectorAll(".screen").forEach((s) => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function showToast(msg) {
      const t = document.getElementById("toast-notification");
      t.innerText = msg; t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 2000);
    }
    
    function openHelp() { document.getElementById("help-modal").style.display = "flex"; }
    function closeHelp() { document.getElementById("help-modal").style.display = "none"; }

    // --- NETWORK ---
    function connect() {
      if(ws) return;
      const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
      ws = new WebSocket(`${protocol}://${location.host}`);
      
      ws.onopen = () => { document.getElementById("lobby-status").innerText = "Connected to Server"; };
      ws.onclose = () => { 
        document.getElementById("lobby-status").innerText = "Disconnected"; 
        showToast("Lost connection");
      };
      
      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if(msg.type === 'ROOM_JOINED') {
          myId = msg.playerId;
          document.getElementById("my-room-code").innerText = msg.code;
          if(msg.isHost) {
            document.getElementById("host-panel").style.display = "block";
            document.getElementById("lobby-status").innerText = "You are Host";
          } else {
            document.getElementById("lobby-status").innerText = "Joined room. Waiting for deal...";
            document.getElementById("host-panel").style.display = "none";
          }
        }
        else if(msg.type === 'PLAYER_UPDATE') {
           document.getElementById("lobby-status").innerText = `Players: ${msg.names.join(", ")}`;
           if(msg.names.length > 1) document.getElementById("btn-deal").disabled = false;
        }
        else if(msg.type === 'GAME_STATE') {
          gameState = msg.state;
          updateGameUI();
        }
        else if(msg.type === 'TOAST') {
          showToast(msg.msg);
          AudioEngine.playError();
          // Shake selected cards if error
          if(selectionOrder.length > 0) {
             const handDiv = document.getElementById("player-hand");
             selectionOrder.forEach(idx => {
               if(handDiv.children[idx]) {
                 handDiv.children[idx].classList.add("shake");
                 setTimeout(()=>handDiv.children[idx].classList.remove("shake"), 500);
               }
             });
          }
        }
      };
    }

    // --- MENU ACTIONS ---
    function signUp() {
      myName = document.getElementById("username-input").value.trim();
      if(!myName) return showToast("Enter Name!");
      localStorage.setItem("username", myName);
      document.getElementById("menu-username").innerText = myName;
      showScreen("menu-screen");
      connect();
    }

    function goToLobby() {
      showScreen("lobby-screen");
    }

    function p2pHost() {
      ws.send(JSON.stringify({ type: 'CREATE_ROOM', name: myName }));
    }
    
    function p2pJoin() {
      const code = document.getElementById("join-code-input").value.trim().toUpperCase();
      if(!code) return showToast("Enter code");
      ws.send(JSON.stringify({ type: 'JOIN_ROOM', code, name: myName }));
    }
    
    function p2pDeal() {
      ws.send(JSON.stringify({ type: 'START_GAME' }));
    }

    // --- GAME ACTIONS ---
    function isMyTurn() {
      return gameState && gameState.players[gameState.turnIndex].id === myId;
    }

    function humanPickup() {
      if(!isMyTurn()) return;
      ws.send(JSON.stringify({ type: 'ACTION_PICKUP' }));
      AudioEngine.playCardSnap();
    }

    function humanPlay() {
      if(!isMyTurn() || selectionOrder.length === 0) return;
      ws.send(JSON.stringify({ type: 'ACTION_PLAY', indices: selectionOrder }));
      selectionOrder = [];
      AudioEngine.playCardSnap();
    }
    
    function humanDeclareLast() {
      ws.send(JSON.stringify({ type: 'ACTION_LAST' }));
      AudioEngine.playCall();
    }
    
    function resolveAce(s) {
      ws.send(JSON.stringify({ type: 'ACTION_SUIT', suitChar: s }));
      document.getElementById("suit-modal").style.display = "none";
    }

    // --- RENDERING ---
    function updateGameUI() {
      showScreen("game-screen");

      // 1. TOP BAR
      const activeP = gameState.players[gameState.turnIndex];
      const isMe = activeP.id === myId;
      const statusDiv = document.getElementById("turn-status");
      statusDiv.innerText = isMe ? "YOUR TURN" : `${activeP.name}'s TURN`;
      statusDiv.style.color = isMe ? "white" : "#ccc";

      let msg = "";
      if(gameState.pendingDraw2) msg = `âš ï¸ DRAW +${gameState.pendingDraw2}`;
      else if(gameState.pendingDrawJ) msg = `âš ï¸ DRAW +${gameState.pendingDrawJ}`;
      else if(gameState.pendingSkip) msg = `âš ï¸ SKIPPED!`;
      document.getElementById("attack-status").innerText = msg;
      
      document.getElementById("status-feed").innerText = isMe ? "Make your move!" : "Waiting for opponent...";

      // 2. DISCARD PILE
      const dp = document.getElementById("discard-pile");
      dp.innerHTML = "";
      if(gameState.discard.length) {
        const top = gameState.discard[gameState.discard.length-1];
        dp.appendChild(createCardDiv(top, -1, false));
        
        // Active suit bubble
        if(gameState.activeSuit) {
           const b = document.createElement("div");
           b.innerText = gameState.activeSuit;
           b.style.cssText = `position:absolute; bottom:-10px; right:-10px; background:white; width:30px; height:30px; border-radius:50%; text-align:center; line-height:30px; border:2px solid black; color:${['â™¥','â™¦'].includes(gameState.activeSuit)?'#d32f2f':'black'}`;
           dp.appendChild(b);
        }
      }

      // 3. OPPONENTS (CPU AREA)
      const cpuArea = document.getElementById("cpu-area");
      cpuArea.innerHTML = "";
      gameState.players.forEach(p => {
        if(p.id === myId) return;
        
        const wrap = document.createElement("div");
        wrap.className = "opponent-wrapper " + (p.id === activeP.id ? "active-turn" : "");
        
        const nameDiv = document.createElement("div");
        nameDiv.className = "opponent-name";
        nameDiv.innerText = `${p.name} (${p.cardCount})`;
        wrap.appendChild(nameDiv);
        
        const handDiv = document.createElement("div");
        handDiv.style.display = "flex";
        handDiv.style.transform = "scale(0.7)";
        const cnt = Math.min(p.cardCount, 5);
        for(let i=0; i<cnt; i++) {
           const c = document.createElement("div");
           c.className = "card back";
           c.style.marginRight = "-45px";
           handDiv.appendChild(c);
        }
        wrap.appendChild(handDiv);
        cpuArea.appendChild(wrap);
      });

      // 4. MY HAND
      const handDiv = document.getElementById("player-hand");
      handDiv.innerHTML = "";
      const me = gameState.players.find(p => p.id === myId);
      
      if(me) {
        const total = me.hand.length;
        const center = (total - 1) / 2;
        me.hand.forEach((c, i) => {
           const card = createCardDiv(c, i, true);
           // FAN LOGIC
           const dist = i - center;
           const angle = Math.max(-20, Math.min(20, dist * 3));
           const y = Math.abs(dist) * 4;
           card.style.setProperty('--fan-rot', `${angle}deg`);
           card.style.setProperty('--fan-y', `${y}px`);
           card.style.zIndex = i;
           handDiv.appendChild(card);
        });

        // Last Button State
        const btnLast = document.getElementById("btn-last");
        if(me.lastDeclared) {
           btnLast.classList.add("called");
           btnLast.innerText = "CALLED";
        } else {
           btnLast.classList.remove("called");
           btnLast.innerText = "LAST!";
        }
        
        // Play Button State
        const btnPlay = document.getElementById("btn-play");
        const btnDraw = document.getElementById("btn-pickup");
        
        btnDraw.disabled = !isMe;
        btnPlay.disabled = !isMe || selectionOrder.length === 0;
        
        if(!btnPlay.disabled && selectionOrder.length === me.hand.length) {
           btnPlay.innerText = "WIN IT!";
           btnPlay.classList.add("winning-btn");
        } else {
           btnPlay.innerText = "PLAY";
           btnPlay.classList.remove("winning-btn");
        }
      }

      // 5. MODALS
      if(gameState.winner) {
        document.getElementById("result-title").innerText = `${gameState.winner} WINS!`;
        document.getElementById("result-desc").innerText = "Game Over";
        document.getElementById("match-result-modal").style.display = "flex";
        AudioEngine.playWin();
      }
      
      if(gameState.awaitingSuit && isMe) {
         document.getElementById("suit-modal").style.display = "flex";
      } else {
         document.getElementById("suit-modal").style.display = "none";
      }
    }

    function createCardDiv(c, i, clickable) {
      const d = document.createElement("div");
      d.className = `card ${['â™¥','â™¦'].includes(c.suit) ? 'red' : ''}`;
      d.innerHTML = `
        <div class="card-corner"><div class="rank">${c.rank}</div><div class="suit">${c.suit}</div></div>
        <div class="center-suit">${c.suit}</div>
        <div class="card-bottom"><div class="rank">${c.rank}</div><div class="suit">${c.suit}</div></div>
      `;
      if(clickable) {
         if(selectionOrder.includes(i)) {
            d.classList.add("selected");
            const badge = document.createElement("div");
            badge.className = "selection-badge";
            badge.innerText = selectionOrder.indexOf(i) + 1;
            d.appendChild(badge);
         }
         d.onclick = () => toggleSelect(i);
      }
      return d;
    }

    function toggleSelect(i) {
      if(!isMyTurn()) return;
      const idx = selectionOrder.indexOf(i);
      if(idx > -1) selectionOrder.splice(idx, 1);
      else {
         selectionOrder.push(i);
         AudioEngine.playTone(300, "sine", 0.05, 0.05);
      }
      updateGameUI();
    }
    
    // Auto-login if saved
    const saved = localStorage.getItem("username");
    if(saved) document.getElementById("username-input").value = saved;

  </script>
</body>
</html>
