<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Schoolyard Switch (Online)</title>
    <style>
        :root {
            --chalk-green: #3a5f42;
            --chalk-white: #eeeeee;
            --paper-white: #fdfbf7;
            --line-blue: #a2d2ff;
            --sticker-yellow: #ffeb3b;
            --sticker-pink: #ff80ab;
            --sticker-blue: #80d8ff;
            --card-w: 70px;
            --card-h: 100px;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Marker Felt', sans-serif;
            background-color: var(--chalk-green);
            color: var(--chalk-white);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            background-image: radial-gradient(#4a6f52 2px, transparent 2px);
            background-size: 30px 30px;
        }

        @media (max-width: 600px) {
            :root { --card-w: 60px; --card-h: 84px; }
            .hud-btn { padding: 10px 10px !important; font-size: 0.8rem !important; }
            #game-info-bar { font-size: 0.8rem !important; padding: 4px !important; }
        }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            background: var(--chalk-green); z-index: 10;
        }
        .screen.active { display: flex; }

        /* --- NOTEBOOK PAPER STYLE --- */
        #login-screen, #menu-screen, #lobby-screen, #online-lobby-screen, #dashboard-screen {
            background-color: var(--paper-white);
            background-image: linear-gradient(var(--line-blue) 1px, transparent 1px);
            background-size: 100% 25px;
            color: #333;
        }

        /* LOGO */
        .logo-text {
            font-size: 3rem; font-weight: 900; color: #d32f2f;
            text-transform: uppercase; text-align: center; margin-bottom: 20px;
            text-shadow: 2px 2px 0px #333; transform: rotate(-3deg);
            background: white; padding: 10px 20px; border: 2px solid #333;
            border-radius: 10px; box-shadow: 5px 5px 0 rgba(0,0,0,0.2);
        }

        input[type="text"] {
            padding: 10px; font-family: inherit; font-size: 1.5rem;
            background: transparent; color: #333; border: none;
            border-bottom: 3px solid #333; width: 250px; text-align: center;
            margin-bottom: 30px; outline: none;
        }

        /* BUTTONS */
        .menu-btn {
            width: 85%; max-width: 320px; padding: 15px;
            border: 3px solid #333;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            font-family: inherit; font-size: 1.4rem; font-weight: bold;
            text-transform: uppercase; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            box-shadow: 3px 3px 0 #333; transition: transform 0.1s;
            margin-bottom: 15px; background: white; color: #333;
        }
        .btn-league { background: var(--sticker-yellow); transform: rotate(1deg); }
        .btn-party { background: var(--sticker-blue); transform: rotate(-1deg); }
        .btn-start { background: var(--sticker-pink); }
        .menu-btn:active { transform: scale(0.95); box-shadow: 1px 1px 0 #333; }
        .menu-btn small { font-size: 0.8rem; font-weight: normal; opacity: 0.8; text-transform: none; }

        /* DASHBOARD */
        .standings-box {
            background: white; width: 90%; border: 3px solid #333;
            border-radius: 10px; padding: 10px; margin-bottom: 20px;
            box-shadow: 5px 5px 0 rgba(0,0,0,0.1);
        }
        table { width: 100%; border-collapse: collapse; font-size: 1rem; }
        th { text-align: left; color: #d32f2f; border-bottom: 2px dashed #333; padding: 8px; }
        td { padding: 10px 8px; border-bottom: 1px solid #ddd; font-weight: bold; }

        /* LOBBY */
        .lobby-list { width: 90%; background: white; border: 3px solid #333; border-radius: 10px; padding: 10px; margin-bottom: 20px; min-height: 200px; }
        .lobby-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px dashed #ccc; font-weight: bold; font-size: 1.2rem; }
        .btn-add { flex: 1; padding: 12px; background: white; border: 2px solid #333; border-radius: 10px; font-weight: bold; cursor: pointer; box-shadow: 3px 3px 0 #ccc; }
        
        /* --- GAME TABLE UI --- */
        #status-feed {
            position: absolute; top: 0; left: 0; width: 100%; height: 35px;
            background: rgba(0,0,0,0.3); color: white;
            font-family: 'Chalkduster', fantasy, sans-serif;
            font-size: 1rem; display: flex; align-items: center; justify-content: center;
            z-index: 20;
        }

        #game-info-bar { 
            position: absolute; top: 40px; left: 10px; right: 10px;
            background: none; padding: 0; font-size: 1rem; text-align: center; z-index: 5;
            display: flex; justify-content: space-between; align-items: center; height: 35px;
        }
        
        .help-btn {
            background: var(--sticker-yellow); color: black; border: 2px solid black;
            border-radius: 50%; width: 35px; height: 35px;
            font-weight: 900; cursor: pointer; font-family: inherit; font-size: 1.2rem;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.5);
        }

        #cpu-area { 
            position: absolute; top: 80px; width: 100%; 
            display: flex; justify-content: space-around; align-items: flex-start;
            height: 120px; padding: 0 10px; box-sizing: border-box;
        }
        .opponent-wrapper { display: flex; flex-direction: column; align-items: center; transform: scale(0.85); transition: opacity 0.3s; }
        .opponent-wrapper.active-turn { opacity: 1; transform: scale(1.1); }
        .opponent-wrapper.inactive { opacity: 0.5; }
        .opponent-name { 
            background: white; color: black; border: 2px solid black; border-radius: 15px 15px 15px 0;
            padding: 4px 10px; font-size: 14px; margin-bottom: 5px; font-weight: bold;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }

        #center-area { position: absolute; top: 52%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 20px; z-index: 2; }
        
        #game-hud { 
            position: absolute; top: 62%; right: 10px; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 10px; z-index: 100;
        }
        .hud-btn { 
            padding: 15px 10px; color: black; border: 3px solid black; border-radius: 10px;
            font-weight: 900; cursor: pointer; box-shadow: 4px 4px 0 rgba(0,0,0,0.3); 
            font-size: 0.9rem; text-transform: uppercase; font-family: inherit;
        }
        #btn-play { background: var(--sticker-pink); transform: rotate(-2deg); }
        #btn-pickup { background: var(--sticker-blue); transform: rotate(2deg); }
        #btn-last { background: var(--sticker-yellow); transform: rotate(-1deg); }
        .hud-btn:disabled { background: #ccc; color: #777; border-color: #777; transform: none; box-shadow: none; }

        #player-area { 
            position: absolute; bottom: 0; width: 100%; height: calc(var(--card-h) + 50px);
            z-index: 50; overflow-x: auto; overflow-y: visible; white-space: nowrap;
            padding: 0 20px; -webkit-overflow-scrolling: touch;
            background-color: #d2a679; /* Wood */
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px);
            border-top: 5px solid #8d6e63;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
        }
        .hand { display: inline-flex; justify-content: center; min-width: 100%; padding-top: 25px; }

        /* --- CARDS --- */
        .card {
            width: var(--card-w); height: var(--card-h); 
            background: white; border-radius: 8px; border: 2px solid #333;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); 
            position: relative; display: inline-flex; 
            flex-direction: column; color: black; flex-shrink: 0;
            transition: transform 0.1s, margin 0.1s; cursor: pointer;
        }
        .card:first-child { margin-left: 0; }
        .card.red { color: #d32f2f; }
        
        .card.back { 
            background-color: #000;
            background-image: radial-gradient(white 15%, transparent 16%), radial-gradient(white 15%, transparent 16%);
            background-size: 10px 10px; background-position: 0 0, 5px 5px;
            border: 3px solid white; 
        }
        .card.back * { display: none; }
        .card.selected { border: 4px solid var(--sticker-pink); transform: translateY(-25px); z-index: 100 !important; }
        .selection-badge { position: absolute; top: -10px; right: -10px; background: var(--sticker-pink); color: black; border-radius: 50%; width: 24px; height: 24px; text-align: center; line-height: 24px; font-weight: bold; z-index: 101; border: 2px solid black; }
        
        .card-corner { position: absolute; top: 2px; left: 4px; display: flex; flex-direction: column; align-items: center; line-height: 0.9; }
        .card-corner .rank { font-size: 22px; font-weight: 900; }
        .card-corner .suit { font-size: 20px; margin-top: -2px; }
        .center-suit { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); font-size: 36px; opacity: 0.2; pointer-events: none; }
        .card-bottom { position: absolute; bottom: 2px; right: 4px; transform: rotate(180deg); display: flex; flex-direction: column; align-items: center; line-height: 0.9; }
        .card-bottom .rank { font-size: 22px; font-weight: 900; }
        .card-bottom .suit { font-size: 20px; margin-top: -2px; }

        /* Pass Screen */
        #pass-device-screen { background: #333; text-align: center; border: 10px solid #fff; box-sizing: border-box;}
        .pass-title { font-size: 2.5rem; color: white; margin-bottom: 20px; font-weight: 900;}
        .pass-btn { padding: 20px 60px; font-size: 1.5rem; background: var(--sticker-yellow); color: black; border: 4px solid black; font-family: inherit; font-weight: bold; cursor: pointer; border-radius: 50px; }

        /* Modals */
        #match-result-modal, #suit-modal, #help-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; 
            z-index: 200; flex-direction: column; color: white; font-family: inherit;
        }
        .suit-btn { font-size: 50px; width: 80px; height: 80px; margin: 10px; cursor: pointer; background: white; border-radius: 20px; border: 3px solid black; box-shadow: 5px 5px 0 rgba(0,0,0,0.5); }
        
        .help-content { background: white; color: #333; border: 4px solid black; padding: 20px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; border-radius: 20px; }
        .help-row { display: flex; justify-content: space-between; border-bottom: 2px dashed #aaa; padding: 10px 0; }
        .help-key { font-weight: 900; color: #d32f2f; width: 40px; font-size: 1.4rem; }

    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <div class="logo-text">Schoolyard<br>Switch</div>
        <input type="text" id="username-input" placeholder="Your Name" maxlength="10">
        <button class="menu-btn btn-start" onclick="signUp()">Join Class</button>
    </div>

    <div id="menu-screen" class="screen">
        <div class="logo-text" style="font-size: 1.5rem; margin-bottom:10px; border:none; background:none; box-shadow:none; transform:none;">Student: <span id="menu-username"></span></div>
        <button class="menu-btn btn-league" onclick="goToLeague()">üèÜ Honor Roll<small>Solo Career ‚Ä¢ Ranked</small></button>
        <button class="menu-btn btn-party" onclick="goToPartyLobby()">‚öΩ Recess Mode<small>Pass & Play ‚Ä¢ Custom</small></button>
        <button class="menu-btn btn-start" style="background: var(--sticker-blue); transform: rotate(1deg);" onclick="goToOnlineLobby()">üåê Online Lobby<small>Create/Join ‚Ä¢ Room Code</small></button>
    </div>

    <div id="dashboard-screen" class="screen">
        <div class="header-row">
            <button onclick="showScreen('menu-screen')" style="background:none; border:none; color:#333; font-size:2rem; font-weight:bold;">‚Ü©</button>
            <h2 style="margin:0; color:#333">HONOR ROLL</h2>
            <div style="width:24px"></div>
        </div>
        <div class="standings-box">
            <table><thead><tr><th>#</th><th>Name</th><th>W-L</th><th>Pts</th></tr></thead><tbody id="standings-body"></tbody></table>
        </div>
        <button class="menu-btn btn-league" style="width:90%" onclick="startLeagueMatch()">Start Match</button>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="header-row">
            <button onclick="showScreen('menu-screen')" style="background:none; border:none; color:#333; font-size:2rem; font-weight:bold;">‚Ü©</button>
            <h2 style="margin:0; color:#333">RECESS SQUAD</h2>
            <div style="width:24px"></div>
        </div>
        <div class="lobby-list" id="lobby-list"></div>
        <div class="lobby-controls" style="display:flex; gap:10px; width:90%; flex-wrap:wrap; justify-content:center;">
            <button class="btn-add" onclick="addLobbyBot()">+ Bot</button>
            <button class="btn-add" onclick="addLobbyHuman()">+ Friend</button>
            <button class="menu-btn btn-start" id="btn-start-party" style="width:100%; margin-top:10px;" onclick="startPartyGame()">DEAL!</button>
        </div>
    </div>


    <div id="online-lobby-screen" class="screen">
        <div class="header-row">
            <button onclick="exitOnlineToMenu()" style="background:none; border:none; color:#333; font-size:2rem; font-weight:bold;">‚Ü©</button>
            <h2 style="margin:0; color:#333">ONLINE LOBBY</h2>
            <div style="width:24px"></div>
        </div>

        <div class="standings-box" style="width:90%; max-width:420px;">
            <div style="font-weight:900; color:#d32f2f; margin-bottom:8px;">Room Code</div>
            <input type="text" id="online-room-input" placeholder="ABCDE" maxlength="8" style="width: 200px; font-size:1.6rem; text-transform:uppercase;">
            <div style="display:flex; gap:10px; width:100%; justify-content:center; margin-top:10px; flex-wrap:wrap;">
                <button class="btn-add" onclick="onlineCreateRoom()">Create</button>
                <button class="btn-add" onclick="onlineJoinRoom()">Join</button>
            </div>
            <div id="online-status" style="margin-top:12px; font-weight:bold; color:#333;">Not connected</div>
        </div>

        <div class="lobby-list" id="online-player-list" style="max-width:420px;"></div>

        <button class="menu-btn btn-start" id="btn-online-start" style="width:90%; max-width:420px;" onclick="onlineStartGame()" disabled>START GAME</button>
        <div style="width:90%; max-width:420px; font-size:0.95rem; color:#333; opacity:0.9; text-align:center;">
            Tip: Share the room code. Host is the first player in the room.
        </div>
    </div>


    <div id="pass-device-screen" class="screen">
        <div class="pass-title">Pass to <span id="next-player-name" style="color:var(--sticker-yellow)">...</span></div>
        <div style="color:white; margin-bottom: 30px; font-size:1.2rem;">(No Peeking!)</div>
        <button class="pass-btn" onclick="startTurn()">I'm Ready!</button>
    </div>

    <div id="game-screen" class="screen">
        <div id="status-feed">Recess Started!</div>
        <div id="game-info-bar">
            <div id="turn-status"></div>
            <div id="attack-status" style="color: var(--sticker-yellow); font-weight: bold; font-size: 0.9rem; text-shadow: 1px 1px 0 #000;"></div>
            <button class="help-btn" onclick="openHelp()">?</button>
        </div>
        <div id="cpu-area"></div>
        <div id="center-area">
            <div id="draw-pile" class="card back" onclick="humanPickup()"></div>
            <div id="discard-pile"></div>
        </div>
        <div id="game-hud">
            <button class="hud-btn" id="btn-play" onclick="humanPlay()">PLAY</button>
            <button class="hud-btn" id="btn-pickup" onclick="humanPickup()">DRAW</button>
            <button class="hud-btn" id="btn-last" onclick="humanDeclareLast()">LAST!</button>
            <button class="hud-btn" onclick="sortPlayerHand()" style="background:#fff; border-color:#333">SORT</button>
        </div>
        <div id="player-area"><div id="player-hand" class="hand"></div></div>
    </div>

    <div id="match-result-modal">
        <h1 id="result-title" style="font-size: 4rem; margin: 0; color: var(--sticker-yellow); text-shadow: 4px 4px 0 #000;"></h1>
        <p id="result-desc" style="font-size: 1.5rem; color: #fff;"></p>
        <button class="menu-btn btn-start" onclick="exitGame()">Back to Class</button>
    </div>
    
    <div id="suit-modal">
        <h2 style="color:white">Pick a Suit!</h2>
        <div style="display:flex; flex-wrap:wrap; justify-content:center;">
            <button class="suit-btn" onclick="resolveAce('H')" style="color:#b71c1c">‚ô•</button>
            <button class="suit-btn" onclick="resolveAce('D')" style="color:#b71c1c">‚ô¶</button>
            <button class="suit-btn" onclick="resolveAce('C')" style="color:black">‚ô£</button>
            <button class="suit-btn" onclick="resolveAce('S')" style="color:black">‚ô†</button>
        </div>
    </div>

    <div id="help-modal" onclick="closeHelp()">
        <div class="help-content" onclick="event.stopPropagation()">
            <h2 style="margin-top:0; color:#333; text-align:center; border-bottom:2px dashed #333; padding-bottom:10px;">CHEAT SHEET</h2>
            <div class="help-row"><div class="help-key">2</div><div class="help-val">Draw 2 (Stacks!)</div></div>
            <div class="help-row"><div class="help-key">8</div><div class="help-val">Skip Next Person</div></div>
            <div class="help-row"><div class="help-key">J</div><div class="help-val">Black: Draw 5<br>Red: Blocks Draw 5</div></div>
            <div class="help-row"><div class="help-key">Q</div><div class="help-val">Reverse Turn</div></div>
            <div class="help-row"><div class="help-key">K</div><div class="help-val">Go Again!</div></div>
            <div class="help-row"><div class="help-key">A</div><div class="help-val">Wild Card (Any Suit)</div></div>
            <button class="menu-btn btn-league" style="width:100%; margin-top:20px;" onclick="closeHelp()">OKAY!</button>
        </div>
    </div>

<script>

// --- SFX (no external files; uses WebAudio so it always works) ---
let _audioCtx = null;
function sfxTone(freq=440, dur=0.06, type="sine", vol=0.07) {
    try {
        if(!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const ctx = _audioCtx;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = type;
        o.frequency.value = freq;
        g.gain.value = vol;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime + dur);
    } catch(e) {}
}
const SFX = {
    click: () => sfxTone(620, 0.04, "square", 0.05),
    draw:  () => sfxTone(320, 0.06, "sine", 0.06),
    play:  () => sfxTone(520, 0.06, "triangle", 0.06),
    win:   () => { sfxTone(660, 0.08, "sine", 0.07); setTimeout(()=>sfxTone(880,0.10,"sine",0.07),90); }
};
function sfx(name){ if(SFX[name]) SFX[name](); }

// --- ONLINE (host-authoritative sync; does NOT change game rules) ---
let ws = null;
let isOnline = false;
let isHost = false;
let myOnlineId = null;
let roomCode = null;

function wsUrl() {
    const proto = (location.protocol === "https:") ? "wss" : "ws";
    return `${proto}://${location.host}/ws`;
}

function setOnlineStatus(t){ const el=document.getElementById("online-status"); if(el) el.innerText=t; }
function renderOnlinePlayers(list){
    const box = document.getElementById("online-player-list");
    if(!box) return;
    box.innerHTML = "";
    list.forEach((p, idx)=>{
        const row = document.createElement("div");
        row.className = "lobby-item";
        const hostTag = p.isHost ? " <small style='color:#d32f2f'>(HOST)</small>" : "";
        row.innerHTML = `<span>${idx+1}. ${p.name}${hostTag}</span>`;
        box.appendChild(row);
    });
}

function goToOnlineLobby(){
    showScreen("online-lobby-screen");
    setOnlineStatus("Not connected");
    renderOnlinePlayers([]);
    document.getElementById("btn-online-start").disabled = true;
}

function exitOnlineToMenu(){
    onlineDisconnect();
    showScreen("menu-screen");
}

function onlineDisconnect(){
    try{ if(ws) ws.close(); }catch(e){}
    ws = null; isOnline=false; isHost=false; myOnlineId=null; roomCode=null;
}

function onlineConnect(){
    return new Promise((resolve, reject)=>{
        try{
            ws = new WebSocket(wsUrl());
            ws.onopen = ()=>resolve();
            ws.onerror = ()=>reject(new Error("ws error"));
            ws.onclose = ()=>{ setOnlineStatus("Disconnected"); document.getElementById("btn-online-start").disabled=true; };
            ws.onmessage = (e)=>{

if(msg.type==="roster" && isHost){
    // Start a fresh online game using roster (no bots in online)
    const cfg = msg.players.map(p=>({ id:p.id, name:p.name, isBot:false }));
    isLeagueMode = false;
    initGame(cfg);
    showScreen("game-screen");
    updateGameUI();
    gameLoop();
    syncState();
}

                let msg; try{ msg=JSON.parse(e.data); }catch{ return; }
                if(msg.type==="room_update"){
                    isHost = !!msg.isHost;
                    myOnlineId = msg.you;
                    isOnline = true;
                    roomCode = msg.room;
                    setOnlineStatus(`Connected ‚Ä¢ Room ${msg.room} ${isHost?"(HOST)":""}`);
                    renderOnlinePlayers(msg.players);
                    document.getElementById("btn-online-start").disabled = !isHost || msg.players.length < 2;
                }
                if(msg.type==="state"){
                    // non-host just renders whatever host sends
                    if(!isHost){
                        importGameState(msg.state);
                        showScreen("game-screen");
                        updateGameUI();
                        updateControls();
                    }
                }
                if(msg.type==="action" && isHost){
                    // host applies remote player actions
                    applyRemoteAction(msg.action);
                }
            };
        }catch(e){ reject(e); }
    });
}

function onlineCreateRoom(){
    const input = document.getElementById("online-room-input");
    const want = (input.value||"").trim().toUpperCase();
    const code = want || Math.random().toString(36).slice(2,7).toUpperCase();
    onlineConnect().then(()=>{
        ws.send(JSON.stringify({ type:"join", room: code, name: leagueData.player.name }));
    }).catch(()=>setOnlineStatus("WebSocket failed"));
}

function onlineJoinRoom(){
    const input = document.getElementById("online-room-input");
    const code = (input.value||"").trim().toUpperCase();
    if(!code) return alert("Enter room code");
    onlineConnect().then(()=>{
        ws.send(JSON.stringify({ type:"join", room: code, name: leagueData.player.name }));
    }).catch(()=>setOnlineStatus("WebSocket failed"));
}

function onlineStartGame(){
    if(!isHost) return;
    // host tells server to broadcast "start" intent; host will init locally then push state
    ws.send(JSON.stringify({ type:"host_start", room: roomCode }));
    // init will happen when host receives its own room_update roster, so do it here safely:
    startOnlineMatchFromRoster();
}

function startOnlineMatchFromRoster(){
    if(!isHost) return;
    // Build player config from last rendered roster by requesting server's current view:
    // We already have roster in UI; simpler: request roster state via a ping.
    ws.send(JSON.stringify({ type:"need_roster" }));
}

function exportGameState(){
    return {
        deck, discard, gamePlayers, turnIndex, direction, activeSuit,
        pendingDraw2, pendingDrawJ, pendingSkip, selectionOrder,
        isProcessing, acePending, isPassAndPlay, extraTurn, isLeagueMode
    };
}

function importGameState(s){
    deck = s.deck; discard = s.discard; gamePlayers = s.gamePlayers;
    turnIndex = s.turnIndex; direction = s.direction; activeSuit = s.activeSuit;
    pendingDraw2 = s.pendingDraw2; pendingDrawJ = s.pendingDrawJ; pendingSkip = s.pendingSkip;
    selectionOrder = s.selectionOrder || [];
    isProcessing = !!s.isProcessing; acePending = !!s.acePending;
    isPassAndPlay = false; // online: no pass device
    extraTurn = !!s.extraTurn; isLeagueMode = !!s.isLeagueMode;
}

function syncState(){
    if(isOnline && isHost && ws && ws.readyState===1){
        ws.send(JSON.stringify({ type:"state", room: roomCode, state: exportGameState() }));
    }
}

function sendAction(action){
    if(isOnline && !isHost && ws && ws.readyState===1){
        ws.send(JSON.stringify({ type:"action", room: roomCode, action: { ...action, playerId: myOnlineId } }));
    }
}

function applyRemoteAction(action){
    // Host only
    if(!isHost || !isOnline) return;
    const current = gamePlayers[turnIndex];
    if(!current || current.id !== action.playerId) return; // not their turn
    if(action.type==="draw") { humanPickup(); return; }
    if(action.type==="last") { humanDeclareLast(); syncState(); return; }
    if(action.type==="play") {
        selectionOrder = action.indices || [];
        humanPlay();
        return;
    }
    if(action.type==="aceSuit") {
        resolveAce(action.char);
        return;
    }
}

    // --- DATA ---
    const BOTS = [
        { name: "Bully Bob", wins: 0, losses: 0, pts: 0 },
        { name: "Teacher", wins: 0, losses: 0, pts: 0 },
        { name: "Nerd Ned", wins: 0, losses: 0, pts: 0 },
        { name: "Cool Cat", wins: 0, losses: 0, pts: 0 },
        { name: "Sporty Sam", wins: 0, losses: 0, pts: 0 }
    ];

    let leagueData = { player: { name: "", wins: 0, losses: 0, pts: 0 }, bots: JSON.parse(JSON.stringify(BOTS)), isLoggedIn: false };
    let lobbyPlayers = [];
    let isLeagueMode = false;

    // --- SETUP ---
    function loadData() {
        const saved = localStorage.getItem('tc_school_v2');
        if(saved) { 
            leagueData = JSON.parse(saved); 
            if(leagueData.isLoggedIn) {
                document.getElementById('menu-username').innerText = leagueData.player.name;
                showScreen('menu-screen');
            }
        }
    }
    function saveData() { localStorage.setItem('tc_school_v2', JSON.stringify(leagueData)); }

    function signUp() {
        const name = document.getElementById('username-input').value.trim();
        if(!name) return alert("Write your name!");
        leagueData.player.name = name; leagueData.isLoggedIn = true; saveData(); 
        document.getElementById('menu-username').innerText = name; showScreen('menu-screen');
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function goToLeague() { showScreen('dashboard-screen'); renderStandings(); }
    function goToPartyLobby() { lobbyPlayers = [{ name: leagueData.player.name, isBot: false }]; renderLobby(); showScreen('lobby-screen'); }

    function renderStandings() {
        const tbody = document.getElementById('standings-body'); tbody.innerHTML = '';
        let all = [leagueData.player, ...leagueData.bots];
        all.sort((a,b) => b.pts - a.pts || b.wins - a.wins);
        all.forEach((p, index) => {
            let row = document.createElement('tr');
            if(p.name === leagueData.player.name) row.style.backgroundColor = "#fff9c4";
            row.innerHTML = `<td>#${index+1}</td><td style="text-align:left; padding-left:10px">${p.name}</td><td>${p.wins}-${p.losses}</td><td style="font-weight:bold; color:#d32f2f">${p.pts}</td>`;
            tbody.appendChild(row);
        });
    }

    // --- LOBBY ---
    function addLobbyBot() {
        if(lobbyPlayers.length >= 4) return alert("Table Full!");
        let bot = leagueData.bots[Math.floor(Math.random() * leagueData.bots.length)];
        lobbyPlayers.push({ name: bot.name, isBot: true }); renderLobby();
    }
    function addLobbyHuman() {
        if(lobbyPlayers.length >= 4) return alert("Table Full!");
        let name = prompt("Friend's Name:", `Player ${lobbyPlayers.length+1}`);
        if(name) { lobbyPlayers.push({ name: name, isBot: false }); renderLobby(); }
    }
    function removeLobby(i) { if(i===0) return; lobbyPlayers.splice(i,1); renderLobby(); }
    function renderLobby() {
        const list = document.getElementById('lobby-list'); list.innerHTML = '';
        lobbyPlayers.forEach((p, i) => {
            let item = document.createElement('div');
            item.className = 'lobby-item';
            item.innerHTML = `<span>${i+1}. ${p.name} <small style="color:#888">${p.isBot?'(BOT)':'(HUMAN)'}</small></span>`;
            if(i > 0) item.innerHTML += `<button onclick="removeLobby(${i})" style="background:#ff5252; color:white; border:none; border-radius:4px; padding:5px 10px; font-weight:bold;">X</button>`;
            list.appendChild(item);
        });
        document.getElementById('btn-start-party').disabled = (lobbyPlayers.length < 2);
    }

    function startLeagueMatch() {
        isLeagueMode = true;
        let opp = leagueData.bots[Math.floor(Math.random() * leagueData.bots.length)];
        initGame([{ name: leagueData.player.name, isBot: false }, { name: opp.name, isBot: true }]);
    }
    function startPartyGame() { isLeagueMode = false; initGame(lobbyPlayers); }

    // --- GAME ENGINE ---
    const SUITS = ["‚ô†", "‚ô•", "‚ô¶", "‚ô£"];
    const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
    const POWER_RANKS = new Set(["A","2","8","J","Q","K"]); 
    const SUIT_MAP = {'H': '‚ô•', 'D': '‚ô¶', 'C': '‚ô£', 'S': '‚ô†'};

    let deck=[], discard=[], gamePlayers=[], turnIndex=0, direction=1, activeSuit=null;
    let pendingDraw2=0, pendingDrawJ=0, pendingSkip=0;
    let selectionOrder = [], isProcessing=false, acePending=false;
    let isPassAndPlay = false, extraTurn = false;

    function initGame(config) {
        deck = createDeck(); shuffle(deck); discard = [];
        turnIndex = 0; direction = 1; activeSuit = null;
        pendingDraw2=0; pendingDrawJ=0; pendingSkip=0;
        selectionOrder = []; isProcessing = false; extraTurn = false;

        gamePlayers = config.map(p => ({ id: p.id || (Math.random().toString(36).slice(2,10)), name: p.name, isBot: p.isBot, hand: [], lastDeclared: false }));
        isPassAndPlay = gamePlayers.some((p, i) => i > 0 && !p.isBot);

        for(let i=0; i<7; i++) gamePlayers.forEach(p => p.hand.push(deck.pop()));

        while(true) {
            let start = deck.pop();
            if(!POWER_RANKS.has(start.rank)) { discard.push(start); activeSuit = start.suit; break; }
            deck.unshift(start);
        }

        sortHand(gamePlayers[0].hand);
        updateFeed("Class is in session!");

        if(isPassAndPlay) triggerPassScreen();
        else { showScreen('game-screen'); updateGameUI(); gameLoop(); }
        syncState();
    }

    function triggerPassScreen() {
        let p = gamePlayers[turnIndex];
        document.getElementById('next-player-name').innerText = p.name;
        showScreen('pass-device-screen');
    }

    function startTurn() { showScreen('game-screen'); updateGameUI(); gameLoop(); }

    function createDeck() { let d=[]; for(let s of SUITS) for(let r of RANKS) d.push({suit:s, rank:r}); return d; }
    function shuffle(arr) { for(let i=arr.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }}

    function gameLoop() {
        if(gamePlayers.some(p => p.hand.length===0)) return; 
        updateGameUI();
        let p = gamePlayers[turnIndex];
        let statusDiv = document.getElementById('turn-status');
        let atkDiv = document.getElementById('attack-status');
        
        statusDiv.innerText = p.isBot ? `${p.name} thinking...` : `${p.name}'S TURN`;
        statusDiv.style.color = p.isBot ? "#ccc" : "white";

        if(p.isBot) { setTimeout(cpuTurn, 1000); } 
        else {
            isProcessing = false; updateControls();
            let msg = "";
            if(pendingDraw2) msg = `‚ö†Ô∏è DRAW +${pendingDraw2}`;
            else if(pendingDrawJ) msg = `‚ö†Ô∏è DRAW +${pendingDrawJ}`;
            else if(pendingSkip) msg = `‚ö†Ô∏è SKIPPED! (8 or Draw)`;
            atkDiv.innerText = msg;
        }
    }

    function nextTurn() {
        syncState();
        turnIndex = (turnIndex + direction + gamePlayers.length) % gamePlayers.length;
        if(isPassAndPlay && !gamePlayers[turnIndex].isBot) setTimeout(triggerPassScreen, 800);
        else gameLoop();
    }

    // --- ACTIONS ---
    function toggleSelect(i) {
        sfx("click");
        if(isProcessing || gamePlayers[turnIndex].isBot) return;
        const existingIdx = selectionOrder.indexOf(i);
        if (existingIdx !== -1) selectionOrder.splice(existingIdx, 1);
        else selectionOrder.push(i);
        renderHandUI(); updateControls();
    }

    function humanPickup() {
        sfx("draw");
        if(isOnline && !isHost){ sendAction({type:"draw"}); return; }
        if(isProcessing) return; isProcessing = true;
        sfx("play");
        let p = gamePlayers[turnIndex];
        
        if(pendingSkip > 0) {
            pendingSkip = 0; updateFeed(`${p.name} missed turn!`);
            p.lastDeclared = false; selectionOrder = []; nextTurn(); return;
        }

        let pen = pendingDraw2 || pendingDrawJ || 1;
        if(pendingDraw2) { pendingDraw2=0; updateFeed(`${p.name} drew ${pen}`); }
        else if(pendingDrawJ) { pendingDrawJ=0; updateFeed(`${p.name} drew ${pen}`); }
        
        p.hand.push(...draw(pen));
        p.lastDeclared = false; sortHand(p.hand); selectionOrder = []; nextTurn();
    }

    function humanDeclareLast() {
        if(isOnline && !isHost){ sendAction({type:"last"}); return; }
        gamePlayers[turnIndex].lastDeclared = true;
        document.getElementById('turn-status').innerText = "CALLED LAST!";
        updateControls();
    }

    function humanPlay() {
        if(isOnline && !isHost){ if(!selectionOrder.length) return; sendAction({type:"play", indices:[...selectionOrder]}); selectionOrder=[]; renderHandUI(); updateControls(); return; }
        if(isProcessing || !selectionOrder.length) return;
        let p = gamePlayers[turnIndex];
        let remaining = p.hand.length - selectionOrder.length;
        if (remaining === 1 && !p.lastDeclared) { alert("‚ö†Ô∏è Call LAST before playing!"); return; }
        attemptPlay(turnIndex, [...selectionOrder]); 
    }

    function attemptPlay(pidx, indices) {
        isProcessing = true;
        let p = gamePlayers[pidx];
        let cards = indices.map(i => p.hand[i]);
        
        let err = null;
        if(pendingDraw2 > 0 && cards[0].rank !== "2") err = "Must play a 2!";
        else if(pendingDrawJ > 0 && cards[0].rank !== "J") err = "Must play a Jack!";
        else if(pendingSkip > 0 && cards[0].rank !== "8") err = "Play an 8 or Draw!";
        else if(!canStart(cards[0], getTop(), activeSuit)) err = "Invalid Card";
        else {
            for(let i=0; i<cards.length-1; i++) {
                if(!linkOk(cards[i], cards[i+1])) err = `Invalid Combo`;
            }
        }
        
        let willFinish = (p.hand.length === cards.length);
        if(willFinish && POWER_RANKS.has(cards[cards.length-1].rank) && cards[cards.length-1].rank !== "K") err = "No power card finish!"; 
        
        if(err) { if(!p.isBot) alert(err); isProcessing = false; return; }

        let removeIndices = [...indices].sort((a,b) => b-a);
        for(let i of removeIndices) p.hand.splice(i, 1);
        
        let isSet = cards.length>1 && cards.every(c=>c.rank===cards[0].rank);
        cards.forEach((c, i) => {
            discard.push(c);
            let isLast = i===cards.length-1;
            if(POWER_RANKS.has(c.rank) && (isSet || isLast)) applyPower(c, pidx, isLast);
        });

        updateFeed(`${p.name} played ${cards.length} card(s)`);
        if(cards[cards.length-1].rank !== "A") activeSuit = cards[cards.length-1].suit;

        if(willFinish && p.hand.length === 0 && !p.lastDeclared && p.hand.length > 0) {
            if(!p.isBot) alert("Forgot LAST! Draw 2");
            p.hand.push(...draw(2));
        }

        selectionOrder = [];
        if(p.hand.length === 0) { endMatch(pidx); return; }

        if(extraTurn) {
            extraTurn = false;
            updateFeed("KING: Play Again!");
            if(p.isBot) { setTimeout(cpuTurn, 1000); }
            else { isProcessing = false; document.getElementById('turn-status').innerText = "PLAY AGAIN!"; updateControls(); }
            return;
        }

        if(acePending && !p.isBot) { document.getElementById('suit-modal').style.display = 'flex'; }
        else { setTimeout(nextTurn, 1000); }
    }

    // --- UTILS ---
    function getTop(){ return discard[discard.length-1]; }
    function rankVal(r){ if(r==="A")return 1; if(r==="J")return 11; if(r==="Q")return 12; if(r==="K")return 13; return parseInt(r); }
    function canStart(c, top, suit){ return c.rank==="A" || c.suit===suit || c.rank===top.rank; }
    function linkOk(p, n){ return p.rank===n.rank || (p.suit===n.suit && Math.abs(rankVal(p.rank)-rankVal(n.rank))===1); }
    
    function draw(n){
        let arr=[];
        for(let i=0; i<n; i++){
            if(deck.length === 0) {
                if(discard.length > 1) {
                    let top=discard.pop(); let rest=discard; discard=[top];
                    shuffle(rest); deck=rest;
                    updateFeed("Reshuffled!");
                } else {
                    let newD = createDeck(); shuffle(newD); deck = newD;
                    updateFeed("New Cards Added!");
                }
            }
            if(deck.length > 0) arr.push(deck.pop());
        }
        return arr;
    }
    
    function applyPower(c, pidx, isLast){
        let r=c.rank;
        if(r==="A" && isLast) {
            if(gamePlayers[pidx].isBot) {
                let counts={"‚ô†":0,"‚ô•":0,"‚ô¶":0,"‚ô£":0};
                gamePlayers[pidx].hand.forEach(x=>counts[x.suit]++);
                activeSuit=Object.keys(counts).reduce((a,b)=>counts[a]>counts[b]?a:b);
                updateFeed(`Suit is ${activeSuit}`);
            } else acePending=true;
        }
        else if(r==="2") pendingDraw2+=2;
        else if(r==="8") pendingSkip++;
        else if(r==="Q") { direction *= -1; updateFeed("Direction Reversed!"); }
        else if(r==="K") extraTurn = true; 
        else if(r==="J") {
            if(c.suit==="‚ô•"||c.suit==="‚ô¶") { if(pendingDrawJ>0) pendingDrawJ=0; updateFeed("Attack Blocked!"); }
            else pendingDrawJ+=5;
        }
    }

    function updateFeed(msg) { document.getElementById('status-feed').innerText = msg; }

    function endMatch(winnerIdx) {
        sfx("win");
        let title = document.getElementById('result-title');
        let desc = document.getElementById('result-desc');
        let modal = document.getElementById('match-result-modal');
        let winner = gamePlayers[winnerIdx];
        if(isLeagueMode) {
            if(winnerIdx === 0) { leagueData.player.wins++; leagueData.player.pts+=3; title.innerText = "A+"; desc.innerText = "You Passed!"; }
            else { leagueData.player.losses++; title.innerText = "F"; desc.innerText = `${winner.name} is top of class`; }
            saveData();
        } else { title.innerText = `${winner.name} WINS!`; desc.innerText = "Recess Over!"; }
        modal.style.display = 'flex';
    }

    function exitGame() {
        document.getElementById('match-result-modal').style.display = 'none';
        if(isLeagueMode) showScreen('dashboard-screen'); else showScreen('lobby-screen');
    }

    function resolveAce(char){
        if(isOnline && !isHost){ sendAction({type:"aceSuit", char}); document.getElementById('suit-modal').style.display='none'; return; } activeSuit=SUIT_MAP[char]; acePending=false; document.getElementById('suit-modal').style.display='none'; nextTurn(); }
    function openHelp() { document.getElementById('help-modal').style.display = 'flex'; }
    function closeHelp() { document.getElementById('help-modal').style.display = 'none'; }

    function cpuTurn() {
        let p = gamePlayers[turnIndex];
        // DEFENSE
        if(pendingDraw2) {
            let idx = p.hand.findIndex(c=>c.rank==="2");
            if(idx>-1) attemptPlay(turnIndex,[idx]); 
            else { 
                let drawn = draw(pendingDraw2); p.hand.push(...drawn); pendingDraw2=0; 
                updateFeed(`${p.name} drew ${drawn.length} cards`); updateGameUI(); setTimeout(nextTurn, 1500); 
            } return;
        }
        if(pendingDrawJ) {
            let idx = p.hand.findIndex(c=>c.rank==="J");
            if(idx>-1) attemptPlay(turnIndex,[idx]); 
            else { 
                let drawn = draw(pendingDrawJ); p.hand.push(...drawn); pendingDrawJ=0; 
                updateFeed(`${p.name} drew ${drawn.length} cards`); updateGameUI(); setTimeout(nextTurn, 1500);
            } return;
        }
        if(pendingSkip > 0) {
            let idx = p.hand.findIndex(c=>c.rank==="8");
            if(idx > -1) attemptPlay(turnIndex, [idx]);
            else { pendingSkip = 0; updateFeed(`${p.name} skipped!`); setTimeout(nextTurn, 1500); }
            return;
        }
        
        // ATTACK
        let bestMove=null; let bestScore=-999;
        p.hand.forEach((c,i)=>{
            if(canStart(c, getTop(), activeSuit)) {
                let setIndices=[i];
                p.hand.forEach((x,xi)=>{ if(xi!==i && x.rank===c.rank) setIndices.push(xi); });
                let score = setIndices.length * 10;
                if(c.rank === "K") score += 50; 
                if(score > bestScore) { bestScore=score; bestMove=setIndices; }
            }
        });
        if(bestMove) {
            if(p.hand.length - bestMove.length === 1) p.lastDeclared=true;
            attemptPlay(turnIndex, bestMove);
        } else {
            let drawn = draw(1); p.hand.push(...drawn); p.lastDeclared=false; 
            updateFeed(`${p.name} drew a card`); updateGameUI(); setTimeout(nextTurn, 1500);
        }
    }

    // --- RENDER ---
    function updateGameUI() {
        let dp = document.getElementById('discard-pile'); dp.innerHTML='';
        if(discard.length) {
            let top=discard[discard.length-1];
            let cardDiv = createCardDiv(top, -1, false);
            dp.appendChild(cardDiv);
            if(top.rank==="A" && activeSuit) {
                 let sDiv = document.createElement('div');
                 sDiv.innerText = activeSuit;
                 sDiv.style.cssText = "position:absolute; bottom:-10px; right:-10px; background:white; width:30px; height:30px; border-radius:50%; text-align:center; font-size:20px; line-height:30px; color:" + (activeSuit==="‚ô•"||activeSuit==="‚ô¶"?"#b71c1c":"black") + "; border:2px solid black;";
                 dp.appendChild(sDiv);
            }
        }
        renderHandUI();
    }

    function renderHandUI() {
        let ph = document.getElementById('player-hand'); ph.innerHTML = '';
        let cpuArea = document.getElementById('cpu-area'); cpuArea.innerHTML = '';
        let activeP = gamePlayers[turnIndex];
        let bottomP, opponents;
        if(isPassAndPlay) {
            bottomP = activeP;
            opponents = gamePlayers.filter(p => p !== activeP);
        } else {
            bottomP = gamePlayers[0];
            opponents = gamePlayers.filter((p,i) => i !== 0);
        }

        if(isPassAndPlay && bottomP.isBot) { /* Hide bot hand */ } else {
            bottomP.hand.forEach((c,i) => {
                let isMyTurn = (bottomP === activeP);
                let cardDiv = createCardDiv(c, i, isMyTurn);

                // Dynamic fan: wider for small hands, tighter for big hands
                const spread = Math.min(40, Math.max(12, 320 / bottomP.hand.length));
                const mid = (bottomP.hand.length - 1) / 2;
                cardDiv.style.marginLeft = (i === 0) ? "0px" : `-${spread}px`;
                cardDiv.style.transform = `rotate(${(i - mid) * 1.2}deg)`;

                ph.appendChild(cardDiv);
            });
        }

        opponents.forEach(p => {
            let wrap = document.createElement('div');
            wrap.className = 'opponent-wrapper ' + (p === activeP ? 'active-turn' : 'inactive');
            let nameDiv = document.createElement('div');
            nameDiv.className = 'opponent-name';
            nameDiv.innerText = `${p.name} (${p.hand.length})`;
            wrap.appendChild(nameDiv);
            let handDiv = document.createElement('div');
            handDiv.style.display = 'flex';
            handDiv.style.transform = 'scale(0.7)';
            let showCount = Math.min(p.hand.length, 5); 
            for(let k=0; k<showCount; k++) {
                let card = document.createElement('div');
                card.className = 'card back';
                card.style.marginRight = "-45px";
                handDiv.appendChild(card);
            }
            wrap.appendChild(handDiv);
            cpuArea.appendChild(wrap);
        });
    }

    function createCardDiv(c, i, isClickable) {
        let d = document.createElement('div');
        d.className = `card ${c.suit==="‚ô•"||c.suit==="‚ô¶"?'red':''}`;
        let corner = document.createElement('div'); corner.className = 'card-corner'; corner.innerHTML = `<div class="rank">${c.rank}</div><div class="suit">${c.suit}</div>`; d.appendChild(corner);
        let center = document.createElement('div'); center.className = 'center-suit'; center.innerText = c.suit; d.appendChild(center);
        let bottom = document.createElement('div'); bottom.className = 'card-bottom'; bottom.innerHTML = `<div class="rank">${c.rank}</div><div class="suit">${c.suit}</div>`; d.appendChild(bottom);

        if(isClickable) {
             let orderIdx = selectionOrder.indexOf(i);
             if(orderIdx !== -1) {
                d.classList.add('selected');
                let badge = document.createElement('div');
                badge.className = 'selection-badge';
                badge.innerText = orderIdx + 1;
                d.appendChild(badge);
             }
             d.onclick = (e) => toggleSelect(i);
        }
        return d;
    }

    function updateControls() {
        document.getElementById('btn-play').disabled = (selectionOrder.length === 0);
        let btnLast = document.getElementById('btn-last');
        if(gamePlayers[turnIndex].lastDeclared) { btnLast.style.background = "#4caf50"; btnLast.innerText = "CALLED"; }
        else { btnLast.style.background = "var(--sticker-yellow)"; btnLast.innerText = "LAST!"; }
    }

    function sortPlayerHand() { sortHand(gamePlayers[turnIndex].hand); selectionOrder = []; renderHandUI(); }
    function sortHand(h) { h.sort((a,b) => { let s = SUITS.indexOf(a.suit) - SUITS.indexOf(b.suit); if(s!==0) return s; return rankVal(a.rank) - rankVal(b.rank); }); }

    loadData();
</script>
</body>
</html>
